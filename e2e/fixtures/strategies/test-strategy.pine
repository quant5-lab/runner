//@version=5
strategy("Minimal Strategy Test", overlay=true, default_qty_type=strategy.cash, commission_type=strategy.commission.percent)

// Simple indicator
sma20 = ta.sma(close, 20)
plot(sma20, "SMA 20", color=color.blue)

// Strategy logic - detect crossovers only (not continuous conditions)
longCrossover = ta.crossover(close, sma20 * 1.02)  // Price crosses ABOVE SMA+2%
shortCrossover = ta.crossunder(close, sma20 * 0.98)  // Price crosses BELOW SMA-2%
neutralZone = close <= sma20 * 1.02 and close >= sma20 * 0.98  // Between SMA Â±2%

// Lock ATR at entry using assignment with ternary
lockedATR = 0.0
lockedATR := strategy.position_size != 0 and nz(lockedATR[1]) > 0 ? nz(lockedATR[1]) : ta.atr(14)

// Strategy calls - ATR-based stops with 5:1 reward/risk (fully inlined)
if longCrossover and strategy.position_size <= 0
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", "Long", limit=close + (ta.atr(14) * 0.8 * 5), stop=close - (ta.atr(14) * 0.8))

if shortCrossover and strategy.position_size >= 0
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", "Short", limit=close - (ta.atr(14) * 0.8 * 5), stop=close + (ta.atr(14) * 0.8))

// Close position when entering neutral zone
if neutralZone
    strategy.close_all()

// Open trade indicators - SL/TP locked to entry ATR
stopLevel = strategy.position_size != 0 ? (strategy.position_size > 0 ? strategy.position_avg_price - (lockedATR * 0.8) : strategy.position_avg_price + (lockedATR * 0.8)) : na
takeProfitLevel = strategy.position_size != 0 ? (strategy.position_size > 0 ? strategy.position_avg_price + (lockedATR * 0.8 * 5) : strategy.position_avg_price - (lockedATR * 0.8 * 5)) : na
plot(stopLevel, "Stop Level", color=color.red, linewidth=2)
plot(takeProfitLevel, "Take Profit Level", color=color.green, linewidth=2)

// Equity tracking
plot(strategy.equity, "Equity", color=color.purple)