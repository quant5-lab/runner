//@version=4
study(title="BB7 Dissect: Volatility Check", shorttitle="BB7-Vol", overlay=true)

// Isolate volatility check mechanism
min_volatility_sl_factor = input(0.8, step=0.05, title='Minimum volatility vs SL factor', type=input.float)
sl_factor = input(1, step=0.1, title='SL Factor', type=input.float)

// Dependencies
sma_bullish = sma(close, 50) > sma(close, 200)
atr_1d = security(syminfo.tickerid, "1D", atr(14))
has_active_trade = false  // Mock: no active trade for testing
position_avg_price_or_close = close
sl_inp = sl_factor * atr_1d / close
stop_level = sma_bullish ? position_avg_price_or_close * (1 - sl_inp) : position_avg_price_or_close * (1 + sl_inp)

// Core Volatility checks
volatility_below_sl = atr(2) <= min_volatility_sl_factor * abs(stop_level - close)
sma_above_atr = (abs(sma(close, 20) - sma(close, 50)) + abs(sma(close, 50) - sma(close, 200))) / 2 >= atr(2)
sma_growing = abs(sma(close, 20) - sma(close, 50)) + abs(sma(close, 50) - sma(close, 200)) > 
   abs(sma(close[4], 20) - sma(close[4], 50)) + abs(sma(close[4], 50) - sma(close[4], 200))
moderate_volatility = volatility_below_sl and sma_above_atr and sma_growing

// Visual output
plot(atr(2), title="ATR(2)", color=color.orange, linewidth=2, pane='atr')

plot(volatility_below_sl ? 1 : na, title="Vol Below SL", color=color.green, linewidth=4, pane='conditions')
plot(sma_above_atr ? 2 : na, title="SMA Above ATR", color=color.blue, linewidth=4, pane='conditions')
plot(sma_growing ? 3 : na, title="SMA Growing", color=color.purple, linewidth=4, pane='conditions')
plot(moderate_volatility ? 4 : na, title="ALL OK", color=color.lime, linewidth=6, pane='conditions')
